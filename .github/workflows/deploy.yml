name: Deploy to Ubuntu VM

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production VM
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Ubuntu VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          ACCESS_TOKEN_EXPIRE_MINUTES: ${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES }}
          LOG_LEVEL: ${{ secrets.LOG_LEVEL }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REDIRECT_URI: ${{ secrets.GOOGLE_REDIRECT_URI }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          envs: MONGO_URI,SECRET_KEY,ACCESS_TOKEN_EXPIRE_MINUTES,LOG_LEVEL,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,GOOGLE_REDIRECT_URI,FRONTEND_URL
          script: |
            # Set working directory
            cd ~

            # Clone or update repository
            if [ -d "fifa-tracker" ]; then
              echo "Repository exists, pulling latest changes..."
              cd fifa-tracker
              git fetch origin
              git reset --hard origin/main
              git pull origin main
            else
              echo "Cloning repository..."
              git clone https://github.com/${{ github.repository }}.git fifa-tracker
              cd fifa-tracker
            fi

            # Create backend .env file with secrets
            mkdir -p backend
            cat > backend/.env << EOF
            MONGO_URI=${MONGO_URI}
            SECRET_KEY=${SECRET_KEY}
            ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES}
            LOG_LEVEL=${LOG_LEVEL}
            GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
            GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
            GOOGLE_REDIRECT_URI=${GOOGLE_REDIRECT_URI}
            FRONTEND_URL=${FRONTEND_URL}
            EOF

            # Stop existing containers and remove images
            echo "Stopping existing containers and removing old images..."
            docker compose -f docker-compose.production.yml down --rmi all --volumes --remove-orphans || true

            # Clean up any remaining unused images
            echo "Cleaning up unused Docker resources..."
            docker system prune -af --volumes || true

            # Build and start containers with fresh build
            echo "Building and starting production containers..."
            docker compose -f docker-compose.production.yml up -d --build --force-recreate

            # Show running containers
            echo "Deployment complete! Running containers:"
            docker compose -f docker-compose.production.yml ps

            # Show logs
            echo "Recent logs:"
            docker compose -f docker-compose.production.yml logs --tail=50
